---
title: "UKB Matching"
output: html_notebook
---

```{r}

rm(list = ls())
cat("\014")

library(MatchIt)
library(dplyr)
library(tidyr)
library(cobalt)
library(MatchIt)
library(gtsummary)

## load data
dat <- read.csv("../data/ukb_demographics_ready_for_matching.csv")

# define matching variables
match_vars <- c(
  "sex",
  "age",
  "loud_music_exposure_frequency",
  "noisy_workplace",
  "hearing_aid_user",
  "hearing_difficultyproblems_with_background_noise",
  "handedness_chiralitylaterality",
  "alcohol_intake_frequency",
  "average_total_household_income_before_tax",
  "speechreceptionthreshold_srt_estimate_left",
  "speechreceptionthreshold_srt_estimate_right"
)

## preprocessing
dat <- dat %>%
  mutate(
    tin_status = factor(tin_status),
    sex = factor(sex),
    loud_music_exposure_frequency = factor(loud_music_exposure_frequency),
    noisy_workplace = factor(noisy_workplace),
    hearing_aid_user = factor(hearing_aid_user),
    hearing_difficultyproblems_with_background_noise =
      factor(hearing_difficultyproblems_with_background_noise),
    handedness_chiralitylaterality =
      factor(handedness_chiralitylaterality),
    alcohol_intake_frequency = factor(alcohol_intake_frequency),
    average_total_household_income_before_tax =
      factor(average_total_household_income_before_tax)
  ) %>%
  drop_na(all_of(c("tin_status", match_vars)))

## matching
match_formula <- as.formula(
  paste("tin_status ~", paste(match_vars, collapse = " + "))
)
m.out <- matchit(
  formula = match_formula,
  data = dat,
  method = "nearest",
  ratio = 1,
  caliper = 0.2,
  replace = FALSE
)

# saving the matched dataset
matched_index <- rownames(match.data(m.out))
matched_data <- dat[as.numeric(matched_index), ]
# write.csv(matched_data, "../data/ukb_demographics_matched.csv", row.names = FALSE)


## plotting
# quartz()
# summary(m.out)
# plot(m.out)
# plot(m.out, type = "jitter", interactive = FALSE)
plot(m.out, type = "density", interactive = FALSE,
     which.xs = ~age + sex)

## stat summery
summary_tbl <- matched_data %>%
    select(tin_status, age, sex) %>%
    tbl_summary(
        by = tin_status,
        statistic = list(
            all_continuous() ~ "{mean} Â± {sd}",
            all_categorical() ~ "{n} ({p}%)"
        ),
        digits = all_continuous() ~ 1
    ) %>%
    add_p() %>%
    bold_labels()

summary_tbl

```