---
title: "Untitled"
author: "Payam Sadeghi Shabestari"
date: "2026-02-13"
output: html_document
---


```{r cars}

install.packages("MatchIt")
install.packages("cobalt")
install.packages("gtsummary")
install.packages("broom", repos = "https://cloud.r-project.org")


rm(list = ls())
cat("\014")

library(MatchIt)
library(dplyr)
library(tidyr)
library(cobalt)
library(gtsummary)

## load data
dat <- read.csv("../../master_files/master.csv")

# define matching variables
match_vars <- c(
  "sex",
  "age",
  "site",
  "PTA"
)

## preprocessing
dat <- dat %>%
  mutate(
    group = factor(group),
    sex = factor(sex),
    age   = as.numeric(age),
    site = factor(site),
    PTA   = as.numeric(PTA)
  ) %>%


## matching
match_formula <- as.formula(
  paste("group ~", paste(match_vars, collapse = " + "))
)
m.out <- matchit(
  formula = match_formula,
  data = dat,
  method = "nearest",
  ratio = 1,
  caliper = 0.2,
  replace = FALSE
)

# saving the matched dataset
matched_data <- match.data(m.out)
# write.csv(matched_data, "ukb_demographics_matched.csv", row.names = FALSE)


## plotting
# quartz()
# summary(m.out)
# plot(m.out)
# plot(m.out, type = "jitter", interactive = FALSE)
plot(m.out, type = "density", interactive = FALSE,
     which.xs = ~age + sex)

## stat summery
summary_tbl <- matched_data %>%
    select(group, age, sex) %>%
    tbl_summary(
        by = group,
        statistic = list(
            all_continuous() ~ "{mean} Â± {sd}",
            all_categorical() ~ "{n} ({p}%)"
        ),
        digits = all_continuous() ~ 1
    ) %>%
    add_p() %>%
    bold_labels()

summary_tbl %>%
  as_gt() %>%
  gt::gtsave("summary_table.html")


```

